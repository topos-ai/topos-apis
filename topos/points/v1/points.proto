syntax = "proto3";

package topos.points.v1;

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "topos/points/v1;points";

service Points {
  // Gets a brand.
  rpc GetBrand(GetBrandRequest) returns (Brand) {
    option (google.api.http) = {
      get : "/v1/{name=brands/*}"
    };
  }

  // Lists brands.
  rpc ListBrands(ListBrandsRequest) returns (ListBrandsResponse) {
    option (google.api.http) = {
      get : "/v1/brands"
    };
  }

  // Sets a brand.
  rpc SetBrand(SetBrandRequest) returns (Brand) {
    option (google.api.http) = {
      post : "/v1/{brand.name=brands/*}:set"
      body : "brand"
    };
  }

  // Deletes a brand.
  rpc DeleteBrand(DeleteBrandRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete : "/v1/{name=brands/*}"
    };
  }

  // Gets a point.
  rpc GetPoint(GetPointRequest) returns (Point) {
    option (google.api.http) = {
      get : "/v1/{name=points/*}"
    };
  }

  // Search points.
  rpc SearchPoints(SearchPointsRequest) returns (SearchPointsResponse) {
    option (google.api.http) = {
      get : "/v1/points:search"
    };
  }

  // Search points.
  rpc PolygonSearchPoints(stream PolygonSearchPointsRequest)
      returns (PolygonSearchPointsResponse) {
    option (google.api.http) = {
      post : "/v1/points:polygon_search"
      body : "*"
    };
  }

  // Creates a point with the given point sources.
  rpc CreatePoint(CreatePointRequest) returns (Point) {
    option (google.api.http) = {
      post : "/v1/points"
      body : "point"
    };
  }

  // Updates an existing point.
  rpc UpdatePoint(UpdatePointRequest) returns (Point) {
    option (google.api.http) = {
      put : "/v1/{point.name=points/*}"
      body : "point"
    };
  }

  // Deletes a point.
  rpc DeletePoint(DeletePointRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete : "/v1/{name=points/*}"
    };
  }

  // Gets a tag.
  rpc GetTag(GetTagRequest) returns (Tag) {
    option (google.api.http) = {
      get : "/v1/{name=tags/*}"
    };
  }

  // Lists tags.
  rpc ListTags(ListTagsRequest) returns (ListTagsResponse) {
    option (google.api.http) = {
      get : "/v1/tags"
    };
  }

  // Sets a tag.
  rpc SetTag(SetTagRequest) returns (Tag) {
    option (google.api.http) = {
      post : "/v1/{tag.name=tags/*}:set"
      body : "tag"
    };
  }

  // Deletes a tag.
  rpc DeleteTag(DeleteTagRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete : "/v1/{name=tags/*}"
    };
  }

  rpc CountBrandPoints(CountBrandPointsRequest)
      returns (CountBrandPointsResponse) {
    option (google.api.http) = {
      get : "/v1/brands:count"
    };
  }

  rpc PolygonCountBrandPoints(stream PolygonCountBrandPointsRequest)
      returns (PolygonCountBrandPointsResponse) {
    option (google.api.http) = {
      post : "/v1/brands:polygon_count"
      body : "*"
    };
  }

  rpc CountTagPoints(CountTagPointsRequest) returns (CountTagPointsResponse) {
    option (google.api.http) = {
      get : "/v1/tags:count"
    };
  }

  rpc PolygonCountTagPoints(stream PolygonCountTagPointsRequest)
      returns (PolygonCountTagPointsResponse) {
    option (google.api.http) = {
      post : "/v1/tags:polygon_count"
      body : "*"
    };
  }

  rpc SearchRegions(SearchRegionsRequest) returns (SearchRegionsResponse) {
    option (google.api.http) = {
      post : "/v1/regions:search"
      body : "*"
    };
  }
}

enum PolygonEncoding {
  S2 = 0;
  GEOJSON = 1;
}

message FeatureStats {
  double min = 1;
  double max = 2;
  double average = 3;
  double median = 4;
}

message Brand {
  // The name of the point brand. It must have the format `"brands/{brand}"`.
  // `{brand}` must match the [regular
  // expression](https://github.com/google/re2/wiki/Syntax)
  // `^[a-z\d]+(-[a-z\d]+)*$`
  string name = 1;

  // The display name of the brand.
  string display_name = 2;

  // The formatted, single-line address of the brand's headquarters.
  string formatted_address = 3;

  // The email of the brand.
  string email = 4;

  // The realestate email of the brand.
  string realestate_email = 5;

  // The phone number of the brand.
  string phone_number = 6;

  message Contact {

    // The full name of the contact.
    string full_name = 1;

    // The title of the contact.
    string title = 2;

    // The phonenumber of the contact.
    string email = 3;

    // The phone number of the contact.
    string phone_number = 4;
  }

  // The contacts for the brand.
  repeated Contact contacts = 7;

  // The [2017 NAICS
  // code](https://www.census.gov/cgi-bin/sssd/naics/naicsrch?chart=2017) of the
  // brand.
  string naics = 8;

  // The postal code of the brand's headquarters.
  string postal_code = 9;

  // The feature set statistics for this brand's locations.
  map<string, FeatureStats> feature_set_feature_stats = 10;

  message Preferences {

    // The prefered square footage of the brand.
    string preferred_gla = 1;

    // The percentage of locations where this brand shares a building.
    double inline = 2;

    // The percentage of locations where this brand occupies a stand-alone
    // building.
    double stand_alone = 3;
  }

  // The brand's location preferences by region.
  map<string, Preferences> region_preferences = 11;

  // A list of brand tags.
  repeated string tags = 12;

  // Exclude the brand from results.
  bool exclude = 13;

  // The creation timestamp of the brand.
  google.protobuf.Timestamp create_time = 14;

  // The last update timestamp of an brand.
  google.protobuf.Timestamp update_time = 15;

  int64 total_locations = 16;
  repeated string states_of_expansion = 17;
  repeated string states_of_operation = 18;
  string website = 19;
}

message LatLng {
  double latitude = 1;
  double longitude = 2;
}

message Point {
  // The name of the point. It must have the format `"points/{point}"`.
  string name = 1;

  // The display name of the point.
  string display_name = 2;

  // The geocoded point address.
  LatLng location = 4;

  // The formatted, single-line address.
  string formatted_address = 5;

  // The names of the point's sources. Each name must have the format
  // `"sources/{source}/pointSources/{point_source}"`. `{source}` must match
  // the [regular expression](https://github.com/google/re2/wiki/Syntax)
  // `^[a-z\d]+(-[a-z\d]+)*$`. {point_source} is the remote point source ID.
  repeated string sources = 6;

  // The name of the point's brand if it has one.
  string brand = 7;

  // A list of point tags.
  repeated string tags = 8;
}

message Tag {
  // The name of the tag. It must have the format `"tags/{tag}"`. `{tag}`
  // must match the [regular
  // expression](https://github.com/google/re2/wiki/Syntax)
  // `^[a-z\d]+(-[a-z\d]+)*$`
  string name = 1;

  // The display name of the tag.
  string display_name = 2;

  // Exclude tag from results.
  bool exclude = 3;

  // The plural display name of the tag.
  string plural_display_name = 4;

  // Is the tag a category.
  bool is_category = 5;
}

message Region {
  // The name of the region. It must have the format
  // `"regionTypes/{region_type}/regions/{region}"`.
  // `{region}` must match the [regular
  // expression](https://github.com/google/re2/wiki/Syntax)
  // `^[a-z\d]+(-[a-z\d]+)*$`
  string name = 1;

  // The WKB-encoded region geometry.
  bytes geometry = 2;
}

message GetBrandRequest { string name = 1; }

message ListBrandsRequest {
  // The maximum number of items to return.
  int32 page_size = 1;

  // The next_page_token value returned from a previous List request, if any.
  string page_token = 2;
}

message ListBrandsResponse {
  repeated Brand brands = 1;

  // Token to retrieve the next page of results, or empty if there are no more
  // results in the list.
  string next_page_token = 2;
}

message SetBrandRequest { Brand brand = 1; }

message DeleteBrandRequest { string name = 1; }

message GetPointRequest { string name = 1; }

message CreatePointRequest { Point point = 1; }

message UpdatePointRequest { Point point = 1; }

message DeletePointRequest { string name = 1; }

message SearchPointsRequest {
  // The maximum number of items to return.
  int32 page_size = 1;

  // The next_page_token value returned from a previous Search request, if any.
  string page_token = 2;

  // Return points with a given brand.
  string brand = 3;

  // Return points within a region.
  string region = 4;

  // Return points with a tag.
  string tag = 5;
}

message SearchPointsResponse {
  repeated Point points = 1;

  // Token to retrieve the next page of results, or empty if there are no more
  // results in the search.
  string next_page_token = 2;
}

message PolygonSearchPointsRequest {
  // The maximum number of items to return.
  int32 page_size = 1;

  // The next_page_token value returned from a previous search request, if any.
  string page_token = 2;

  // Return points with a given brand.
  string brand = 3;

  // Return points with the given tags.
  repeated string tags = 4;

  // The polygon data's encoding.
  PolygonEncoding polygon_encoding = 5;

  // A chunk of bytes of the encoded S2 polygon.
  bytes polygon_chunk = 15;
}

message PolygonSearchPointsResponse {
  repeated Point points = 1;

  // Token to retrieve the next page of results, or empty if there are no more
  // results in the search.
  string next_page_token = 2;
}

message GetTagRequest { string name = 1; }

message SetTagRequest { Tag tag = 1; }

message ListTagsRequest {
  // The maximum number of items to return.
  int32 page_size = 1;

  // The next_page_token value returned from a previous List request, if any.
  string page_token = 2;
}

message ListTagsResponse {
  repeated Tag tags = 1;

  // Token to retrieve the next page of results, or empty if there are no more
  // results in the list.
  string next_page_token = 2;
}

message DeleteTagRequest { string name = 1; }

message CountBrandPointsRequest {
  // Count brand points within this region.
  string region = 1;

  // Count points for the given brands.
  repeated string brands = 2;
}

message CountBrandPointsResponse {
  // Map of brand IDs to point counts.
  map<string, int64> brand_points = 1;
}

message PolygonCountBrandPointsRequest {
  // Count brand points within this region.
  string region = 1;

  // Count points for the given brands.
  repeated string brands = 2;

  // The polygon data's encoding.
  PolygonEncoding polygon_encoding = 3;

  // A chunk of bytes of the encoded S2 polygon.
  bytes polygon_chunk = 15;
}

message PolygonCountBrandPointsResponse {
  // Map of brand IDs to point counts.
  map<string, int64> brand_points = 1;
}

message CountTagPointsRequest {
  // Count brand points within this region.
  string region = 1;

  // Count points for the given tag.
  string tag = 2;
}

message CountTagPointsResponse {
  // Map of tag IDs to point counts.
  map<string, int64> tag_points = 1;
}

message PolygonCountTagPointsRequest {
  // Count brand points within this region.
  string region = 1;

  // Count points for the given tag.
  string tag = 2;

  // The polygon data's encoding.
  PolygonEncoding polygon_encoding = 3;

  // A chunk of bytes of the encoded polygon.
  bytes polygon_chunk = 15;
}

message PolygonCountTagPointsResponse {
  // Map of tag IDs to point counts.
  map<string, int64> tag_points = 1;
}

message SearchRegionsRequest {
  // The maximum number of items to return.
  int32 page_size = 1;

  // The next_page_token value returned from a previous Search request, if any.
  string page_token = 2;

  // Return regions of the given type.
  string region_type = 3;

  // Return regions that intersect with locations of the given brand.
  string brand = 4;
}

message SearchRegionsResponse {
  repeated Region regions = 1;

  // Token to retrieve the next page of results, or empty if there are no more
  // results in the search.
  string next_page_token = 2;
}
